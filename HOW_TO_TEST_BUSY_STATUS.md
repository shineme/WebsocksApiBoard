# 如何测试 Worker 忙碌状态

## 问题说明

你之前看到 Worker 一直显示"空闲"状态，这是因为：

1. **Worker 默认是空闲的** - 只有在执行任务时才会变成"忙碌中"
2. **发送 ready 消息不会改变状态** - ready 消息只是告诉服务器 Worker 准备好接收任务
3. **需要服务器分配任务** - Worker 才会变成忙碌状态

## 🎯 测试方法

### 方法 1: 使用管理看板的"分配任务"按钮（推荐）

这是最简单的方法！

1. **打开 Worker 测试工具**
   ```
   http://localhost:3000/test-worker
   ```
   - 点击"连接"按钮
   - 等待连接成功

2. **打开管理看板**
   ```
   http://localhost:3000/dashboard
   ```
   - 在 Worker 状态表格中找到你的 Worker
   - 点击该 Worker 行最右侧的"分配任务"按钮

3. **观察状态变化**
   - ✅ Worker 状态立即变为"忙碌中"（桃色徽章）
   - ✅ "当前任务"列显示任务 ID
   - ✅ "忙碌 Worker 数量"指标增加
   - ✅ Worker 测试工具的日志显示收到任务
   - ✅ 2 秒后 Worker 自动完成任务，状态变回"空闲"
   - ✅ 请求日志中出现任务完成记录

### 方法 2: 在 Worker 测试工具中手动模拟

如果你想手动控制：

1. **连接 Worker**
   ```
   http://localhost:3000/test-worker
   ```

2. **在自定义消息框中输入**
   ```json
   {
     "type": "task_complete",
     "taskId": "test-task-123",
     "result": {"status": "success"},
     "duration": 2000
   }
   ```

3. **点击"发送自定义消息"**
   - 这会模拟任务完成
   - 在管理看板的"请求日志"中查看记录

## 📊 完整测试流程

### 测试 1: 单个 Worker 忙碌状态

```
1. 打开 Worker 测试工具，连接 1 个 Worker
2. 打开管理看板，确认显示 1 个空闲 Worker
3. 在管理看板中点击"分配任务"按钮
4. 观察：
   - Worker 状态变为"忙碌中"
   - 当前任务显示任务 ID
   - 忙碌 Worker 数量 = 1
5. 等待 2 秒
6. 观察：
   - Worker 状态变回"空闲"
   - 当前任务显示"无任务"
   - 忙碌 Worker 数量 = 0
   - 请求日志中出现任务完成记录
```

### 测试 2: 多个 Worker 同时忙碌

```
1. 打开 3 个 Worker 测试工具标签页
2. 全部连接
3. 在管理看板中确认显示 3 个空闲 Worker
4. 快速点击 3 个 Worker 的"分配任务"按钮
5. 观察：
   - 3 个 Worker 都变为"忙碌中"
   - 忙碌 Worker 数量 = 3
6. 等待 2 秒
7. 观察：
   - 3 个 Worker 陆续变回"空闲"
   - 请求日志中出现 3 条任务完成记录
```

### 测试 3: Worker 忙碌时无法分配新任务

```
1. 连接 1 个 Worker
2. 点击"分配任务"按钮
3. Worker 变为"忙碌中"
4. 再次点击"分配任务"按钮
5. 观察：
   - 按钮变灰，显示为禁用状态
   - 无法分配新任务
6. 等待 2 秒后 Worker 变回空闲
7. "分配任务"按钮重新可用
```

## 🔍 状态指示器说明

### Worker 状态徽章

| 状态 | 颜色 | 说明 |
|------|------|------|
| **空闲** | 柔和蓝色 | Worker 可以接收新任务 |
| **忙碌中** | 柔和桃色 | Worker 正在执行任务 |

### 指标卡片

| 指标 | 说明 |
|------|------|
| **在线 Worker 总数** | 当前连接的 Worker 数量 |
| **忙碌 Worker 数量** | 正在执行任务的 Worker 数量 |
| **全局任务队列长度** | 等待分配的任务数量（当前为 0） |
| **平均等待时间** | 任务在队列中的平均等待时间 |

## 💡 理解 Worker 状态

### Worker 生命周期

```
连接 → 空闲 → 接收任务 → 忙碌中 → 完成任务 → 空闲 → ...
```

### 状态转换触发条件

1. **空闲 → 忙碌中**
   - 服务器分配任务给 Worker
   - Worker 收到 `type: 'task'` 消息

2. **忙碌中 → 空闲**
   - Worker 发送 `type: 'task_complete'` 消息
   - Worker 发送 `type: 'task_error'` 消息
   - Worker 发送 `type: 'ready'` 消息

### 常见误解

❌ **错误**: 发送 `{"type": "ready"}` 会让 Worker 变忙碌
✅ **正确**: ready 消息只是告诉服务器 Worker 准备好了，不会改变状态

❌ **错误**: 发送任意消息都会改变状态
✅ **正确**: 只有特定的消息类型会触发状态变化

❌ **错误**: Worker 连接后就是忙碌的
✅ **正确**: Worker 连接后默认是空闲的

## 🎨 UI 效果

### 空闲状态
```
┌─────────────────────────────────────────────────┐
│ Worker ID    │ IP          │ 状态  │ 当前任务  │
├─────────────────────────────────────────────────┤
│ worker-001   │ 127.0.0.1   │ 空闲  │ 无任务    │
│              │             │ 🔵    │           │
└─────────────────────────────────────────────────┘
```

### 忙碌状态
```
┌─────────────────────────────────────────────────┐
│ Worker ID    │ IP          │ 状态    │ 当前任务    │
├─────────────────────────────────────────────────┤
│ worker-001   │ 127.0.0.1   │ 忙碌中  │ task-123   │
│              │             │ 🟠      │            │
└─────────────────────────────────────────────────┘
```

## 🐛 故障排查

### 问题：点击"分配任务"后状态没有变化

**可能原因**:
1. Worker 连接已断开
2. 浏览器缓存问题
3. 自动刷新延迟

**解决方案**:
1. 检查 Worker 测试工具是否显示"已连接"
2. 刷新管理看板页面
3. 等待 3 秒让自动刷新生效

### 问题：Worker 一直显示忙碌

**可能原因**:
1. Worker 没有发送任务完成消息
2. WebSocket 连接中断

**解决方案**:
1. 在 Worker 测试工具中手动发送 task_complete 消息
2. 断开并重新连接 Worker

### 问题："分配任务"按钮一直禁用

**可能原因**:
1. Worker 正在忙碌
2. 上一次分配还在进行中

**解决方案**:
1. 等待 Worker 完成当前任务
2. 刷新页面

## 📝 测试检查清单

完成以下测试：

- [ ] 单个 Worker 从空闲变为忙碌
- [ ] Worker 完成任务后变回空闲
- [ ] 多个 Worker 同时忙碌
- [ ] 忙碌 Worker 无法接收新任务
- [ ] 指标卡片正确显示忙碌 Worker 数量
- [ ] 请求日志记录任务完成
- [ ] 日志详情显示任务 ID
- [ ] Worker 断开连接后从列表消失
- [ ] 重新连接后获得新的 Worker ID

## 🎉 现在开始测试！

1. 确保服务器正在运行
2. 打开 Worker 测试工具和管理看板
3. 连接 Worker
4. 点击"分配任务"按钮
5. 观察状态变化

祝测试顺利！🚀
