# 测试指南

## 🎯 完整测试流程

### 1. 启动服务器

```bash
npm run dev
```

服务器将在以下地址启动：
- **HTTP**: http://localhost:3000
- **WebSocket**: ws://localhost:3000/ws

### 2. 打开测试页面

在浏览器中打开两个标签页：

#### 标签页 1: Worker 测试工具
```
http://localhost:3000/test-worker
```

这个页面用于模拟 Worker 连接和测试 WebSocket 通信。

#### 标签页 2: 管理看板
```
http://localhost:3000/dashboard
```

这个页面用于实时查看系统状态和 Worker 信息。

### 3. 测试 Worker 连接

在 **Worker 测试工具** 页面：

1. **连接 WebSocket**
   - 确认 URL 为 `ws://localhost:3000/ws`
   - 勾选"连接后自动发送 ready 消息"
   - 点击"连接"按钮
   - 观察日志，应该看到：
     ```
     ✓ WebSocket 连接成功
     Worker ID: worker-xxxxx
     → 发送: {"type":"ready"}
     ```

2. **查看管理看板**
   - 切换到管理看板标签页
   - 在"监控面板"中应该看到：
     - 在线 Worker 总数: 1
     - Worker 状态表格中显示你的 Worker
     - 状态显示为"空闲"
     - 连接时长实时更新

### 4. 测试多个 Worker

打开多个 Worker 测试工具标签页（建议 2-3 个）：

1. 在每个标签页中点击"连接"
2. 在管理看板中观察：
   - 在线 Worker 总数增加
   - Worker 状态表格显示所有连接的 Worker
   - 每个 Worker 有唯一的 ID 和 IP 地址

### 5. 测试任务完成

在任意 Worker 测试工具页面：

1. 点击"模拟任务完成"按钮
2. 观察日志：
   ```
   → 发送: {
     "type": "task_complete",
     "taskId": "test-task-123",
     "result": {"result": "Success"},
     "duration": 2000
   }
   ```

3. 切换到管理看板的"请求日志"标签
4. 应该看到新的日志条目：
   - 方法: TASK
   - 路径: /task/complete
   - 状态码: 200
   - 延迟: 2000ms

5. 点击日志行展开详情，查看完整的请求和响应数据

### 6. 测试任务失败

在任意 Worker 测试工具页面：

1. 点击"模拟任务失败"按钮
2. 在管理看板的"请求日志"中查看
3. 应该看到：
   - 状态码: 500（红色背景）
   - 错误信息在响应体中

### 7. 测试自定义消息

在 Worker 测试工具页面：

1. 在"自定义消息"文本框中输入：
   ```json
   {
     "type": "ping"
   }
   ```

2. 点击"发送自定义消息"
3. 观察日志，应该收到 pong 响应：
   ```
   ← 收到: {"type":"pong"}
   ```

### 8. 测试断开连接

1. 在 Worker 测试工具中点击"断开"按钮
2. 在管理看板中观察：
   - 在线 Worker 总数减少
   - Worker 从状态表格中消失

### 9. 测试自动刷新

管理看板会自动刷新数据：
- 指标和 Worker 状态：每 3 秒
- 请求日志：每 1.5 秒

观察页面上的"上次更新"时间戳，确认自动刷新正常工作。

## 🧪 高级测试场景

### 场景 1: 压力测试

1. 打开 10 个 Worker 测试工具标签页
2. 全部连接到 WebSocket
3. 在管理看板中观察性能
4. 随机在不同 Worker 中发送任务完成/失败消息
5. 观察日志是否正常记录

### 场景 2: 断线重连

1. 连接一个 Worker
2. 停止服务器（Ctrl+C）
3. 观察 Worker 测试工具显示连接关闭
4. 重启服务器
5. 在 Worker 测试工具中重新连接
6. 确认新的 Worker ID 被分配

### 场景 3: 长时间运行

1. 连接多个 Worker
2. 让它们保持连接状态 10+ 分钟
3. 观察连接时长是否正确更新
4. 定期发送消息确认连接稳定

### 场景 4: 响应式测试

1. 在不同设备上打开管理看板：
   - 桌面浏览器（全屏）
   - 缩小浏览器窗口
   - 移动设备（或开发者工具的设备模拟）

2. 确认布局正确适配：
   - 桌面：4 列指标卡片
   - 移动：1 列指标卡片
   - 表格支持横向滚动

## 📊 预期结果

### 正常状态指标

- **在线 Worker 总数**: 根据连接的 Worker 数量
- **全局任务队列长度**: 0（当前实现未使用队列）
- **忙碌 Worker 数量**: 0（Worker 完成任务后立即变为空闲）
- **平均等待时间**: 0ms

### Worker 状态

每个连接的 Worker 应该显示：
- ✅ 唯一的 Worker ID（前 8 位）
- ✅ IP 地址
- ✅ 状态徽章（空闲/忙碌中）
- ✅ 当前任务（无任务时显示"无任务"）
- ✅ 连接时长（实时更新）

### 请求日志

每条日志应该包含：
- ✅ 时间戳
- ✅ HTTP 方法
- ✅ 路径
- ✅ 状态码（带颜色标识）
- ✅ 延迟（带颜色标识）
- ✅ 可展开的详细信息

## 🐛 故障排查

### 问题：无法连接 WebSocket

**症状**: Worker 测试工具显示连接失败

**解决方案**:
1. 确认服务器正在运行
2. 检查 URL 是否正确（ws://localhost:3000/ws）
3. 查看浏览器控制台是否有错误
4. 确认端口 3000 未被其他程序占用

### 问题：管理看板不显示 Worker

**症状**: 连接成功但看板显示 0 个 Worker

**解决方案**:
1. 刷新管理看板页面
2. 检查浏览器控制台的网络请求
3. 确认 API 端点返回正确数据：
   ```bash
   curl http://localhost:3000/api/dashboard/workers
   ```

### 问题：日志不显示

**症状**: 发送消息后日志面板为空

**解决方案**:
1. 确认发送的是 task_complete 或 task_error 消息
2. 切换到"请求日志"标签
3. 等待 1.5 秒让自动刷新生效
4. 检查 API 端点：
   ```bash
   curl http://localhost:3000/api/dashboard/logs
   ```

### 问题：连接时长不更新

**症状**: Worker 连接时长显示但不变化

**解决方案**:
1. 这是正常的，时长每秒更新一次
2. 如果完全不更新，刷新页面
3. 检查浏览器控制台是否有 JavaScript 错误

## 🎨 自定义测试

### 修改刷新间隔

编辑 `app/dashboard/page.tsx`:

```typescript
// 改为每 1 秒刷新指标
const interval = setInterval(fetchMetricsAndWorkers, 1000);

// 改为每 500ms 刷新日志
const interval = setInterval(fetchLogs, 500);
```

### 添加测试数据

在 Worker 测试工具中发送自定义消息：

```json
{
  "type": "task_complete",
  "taskId": "custom-task-001",
  "result": {
    "data": "Your custom result",
    "timestamp": 1234567890
  },
  "duration": 5000
}
```

## 📝 测试检查清单

完成以下测试项目：

- [ ] 单个 Worker 连接成功
- [ ] 多个 Worker 同时连接
- [ ] Worker 状态在看板中正确显示
- [ ] 发送 ready 消息
- [ ] 模拟任务完成
- [ ] 模拟任务失败
- [ ] 自定义消息发送和接收
- [ ] 日志正确记录和显示
- [ ] 日志详情展开/折叠
- [ ] 状态码颜色标识正确
- [ ] 延迟颜色标识正确
- [ ] Worker 断开连接
- [ ] 连接时长实时更新
- [ ] 自动刷新功能正常
- [ ] Tab 切换流畅
- [ ] 响应式布局正确
- [ ] 心跳机制正常工作

## 🚀 下一步

测试完成后，你可以：

1. **集成真实的任务处理逻辑**
   - 修改 `server.js` 中的消息处理
   - 实现任务队列和分发机制

2. **添加认证**
   - Worker 连接时验证 token
   - 管理看板添加登录功能

3. **持久化存储**
   - 将日志保存到数据库
   - 记录 Worker 历史连接信息

4. **监控告警**
   - Worker 离线告警
   - 任务失败率监控
   - 性能指标追踪

5. **部署到生产环境**
   - 使用 Docker 容器化
   - 配置 Nginx 反向代理
   - 启用 HTTPS

祝测试顺利！🎉
